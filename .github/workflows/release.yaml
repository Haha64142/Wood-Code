name: Build and Release

on:
  push:
    tags:
      - "release/*" # Only run on tags like release/1.3.5

jobs:
  build:
    name: Build & Release (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up CMake and Ninja
        uses: lukka/get-cmake@latest

      - name: Extract version from tag
        id: get_version
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#release/}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Configure project
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -G Ninja

      - name: Build project
        run: cmake --build build --config Release

      - name: Package with CPack
        run: cpack --config build/CPackConfig.cmake

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          name: WoodCode v${{ steps.get_version.outputs.version }}
          tag_name: release/${{ steps.get_version.outputs.version }}
          body: |
            This release contains pre-built binaries for WoodCode v${{ steps.get_version.outputs.version }}

            This is the first working version of the WoodCode encoder/decoder.

            For protocol doc and more info, see the main [README](https://github.com/Haha64142/Wood-Code/blob/main/README.md) for details.

            ---
            _This release was built and published automatically via GitHub Actions._
          files: |
            *.zip
            *.tar.gz
          update_existing: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print release version
        shell: bash
        run: |
          echo "Released version: ${{ steps.get_version.outputs.version }}"
