name: Build and Release

on:
  push:
    tags:
      - "release/*" # Only run on tags like release/1.3.5

jobs:
  build:
    name: Build & Release (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up CMake and Ninja
        uses: lukka/get-cmake@latest

      - name: Extract version from tag
        id: get_version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#release/}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Configure project
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -G Ninja

      - name: Build project
        run: cmake --build build --config Release

      - name: Package with CPack
        run: cpack --config build/CPackConfig.cmake

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.zip
            *.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print release version
        run: |
          echo "Released version: ${{ steps.get_version.outputs.version }}"
